name: fastq-dl

on:
  push:
    branches: [main, master, dev]
  pull_request:
    branches: [main, master, dev]
  schedule:
    # Run weekly on Sundays at 2:00 AM UTC
    - cron: "0 2 * * 0"
  workflow_dispatch: # Allow manual triggers

jobs:
  # Job 1: Fast unit tests on all Python versions
  unit-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    defaults:
      run:
        shell: bash -el {0}
    steps:
      - name: Checkout rpetit3/fastq-dl
        uses: actions/checkout@v4

      - uses: taiki-e/install-action@just

      - uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: ${{ matrix.python-version }}
          channels: conda-forge,bioconda
          channel-priority: strict
          activate-environment: fastq-dl
          environment-file: environment.yml
          auto-update-conda: true

      - name: Install fastq-dl
        run: just install

      - name: Check formatting
        run: just check-fmt

      - name: Lint
        run: just lint

      - name: Run unit tests with coverage
        run: |
          poetry run pytest tests/ \
            --cov=fastq_dl \
            --cov-report=xml \
            --cov-report=term-missing \
            --cov-fail-under=70 \
            -m "not integration" \
            --verbosity=2

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.10'
        with:
          file: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # Job 2: Integration tests (only on push to main/master or scheduled)
  integration-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'))
    needs: unit-tests
    defaults:
      run:
        shell: bash -el {0}
    steps:
      - name: Checkout rpetit3/fastq-dl
        uses: actions/checkout@v4

      - uses: taiki-e/install-action@just

      - uses: conda-incubator/setup-miniconda@v3
        with:
          python-version: "3.10"
          channels: conda-forge,bioconda
          channel-priority: strict
          activate-environment: fastq-dl
          environment-file: environment.yml
          auto-update-conda: true

      - name: Install fastq-dl
        run: just install

      - name: Verify installation
        run: |
          fastq-dl --version
          fastq-dl --help

      - name: Test ENA Download
        run: |
          fastq-dl --accession SRX1390608 --outdir test-ena --verbose

      - name: Test ENA Metadata only
        run: |
          fastq-dl --accession SRX1390608 --outdir test-ena-metadata --verbose --only-download-metadata

      - name: Test SRA Download
        run: |
          fastq-dl --accession SRX1390608 --provider SRA --outdir test-sra --verbose

      - name: Test SRA Metadata only
        run: |
          fastq-dl --accession SRX1390608 --provider SRA --outdir test-sra-metadata --verbose --only-provider --only-download-metadata

      - name: Test Experiment with duplicate runs
        run: |
          fastq-dl --accession ERX012546 --provider sra --outdir test-duplicate --verbose

      - name: Test Small Run (SRA)
        run: |
          fastq-dl --accession SRX3606281 --provider SrA --outdir test-small-sra --verbose

      - name: Test Small Run (SRA) with --force
        run: |
          fastq-dl --accession SRX3606281 --provider SrA --outdir test-small-sra --verbose --force

      - name: Test Small Run (ENA)
        run: |
          fastq-dl --accession SRX3606281 --outdir test-small-ena --verbose

      - name: Test Small Run (ENA) with --force
        run: |
          fastq-dl --accession SRX3606281 --outdir test-small-ena --verbose --force

      - name: Test BioSample (ENA)
        run: |
          fastq-dl --accession SAMN06191622 --outdir test-biosample --verbose

      - name: Test Sample (SRA)
        run: |
          fastq-dl --accession SRS1904245 --provider SRA --outdir test-sample --verbose

      - name: Test --group-by-sample (ENA)
        run: |
          fastq-dl --accession SRS1904245 --outdir test-group-by-sample --verbose --group-by-sample

      - name: Test --group-by-experiment (SRA)
        run: |
          fastq-dl --accession ERX012546 --outdir test-group-by-experiment --verbose --group-by-sample --provider SRA

      - name: Test --group-by-experiment (SRA Lite)
        run: |
          fastq-dl --accession ERX012546 --outdir test-group-by-experiment-lite --verbose --group-by-sample --provider SRA --sra-lite

      - name: Test BioSample (ENA, ignore MD5sum)
        run: |
          fastq-dl --accession SAMN06191622 --outdir test-biosample-ignore --verbose --ignore

  # Job 3: Notify on scheduled run failures
  notify-failure:
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: failure() && github.event_name == 'schedule'
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Weekly CI Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `The weekly scheduled CI run has failed.

            Please check the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.

            This may indicate breaking changes in ENA/SRA APIs or sra-tools updates.`;

            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure'
            });

            if (!issues.data.find(i => i.title.startsWith('Weekly CI Failed'))) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['ci-failure', 'automated']
              });
            }
